<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>財經數據追蹤</title>
  <script src="https://unpkg.com/chart.js@4.4.4/dist/chart.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">財經數據追蹤</h1>
    <button
      id="export-csv"
      class="bg-blue-500 text-white px-4 py-2 rounded mb-4"
    >
      下載 CSV
    </button>
    <div id="error" class="text-red-500 mb-4 hidden"></div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">黃金價格 (美元/盎司)</h2>
        <canvas id="gold-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">TIPS 實質利率 (%)</h2>
        <canvas id="tips-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">美債殖利率 (%)</h2>
        <canvas id="usBondYield-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">美元指數</h2>
        <canvas id="usdIndex-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">美元匯率 (TWD)</h2>
        <canvas id="usdTwd-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">日圓匯率 (TWD)</h2>
        <canvas id="jpyTwd-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">VIX 指數</h2>
        <canvas id="vix-chart"></canvas>
      </div>
      <div class="p-4 border rounded">
        <h2 class="text-xl font-semibold mb-2">日經指數</h2>
        <canvas id="nikkei-chart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // 等待 Chart.js 載入完成
    function waitForChartJs(callback) {
      if (typeof Chart !== 'undefined') {
        callback();
      } else {
        setTimeout(() => waitForChartJs(callback), 100);
      }
    }

    // 財經數據項目
    const dataItems = [
      { key: 'gold', label: '黃金價格 (美元/盎司)', chartId: 'gold-chart', api: 'TIME_SERIES_WEEKLY', symbol: 'GOLD' },
      { key: 'tips', label: 'TIPS 實質利率 (%)', chartId: 'tips-chart', api: 'mock' },
      { key: 'usBondYield', label: '美債殖利率 (%)', chartId: 'usBondYield-chart', api: 'mock' },
      { key: 'usdIndex', label: '美元指數', chartId: 'usdIndex-chart', api: 'TIME_SERIES_WEEKLY', symbol: 'DX-Y.NYB' },
      { key: 'usdTwd', label: '美元匯率 (TWD)', chartId: 'usdTwd-chart', api: 'CURRENCY_EXCHANGE_RATE', from: 'USD', to: 'TWD' },
      { key: 'jpyTwd', label: '日圓匯率 (TWD)', chartId: 'jpyTwd-chart', api: 'CURRENCY_EXCHANGE_RATE', from: 'JPY', to: 'TWD' },
      { key: 'vix', label: 'VIX 指數', chartId: 'vix-chart', api: 'TIME_SERIES_WEEKLY', symbol: 'VIX' },
      { key: 'nikkei', label: '日經指數', chartId: 'nikkei-chart', api: 'TIME_SERIES_WEEKLY', symbol: '^N225' },
    ];

    // 模擬數據生成
    function generateMockData() {
      const data = [];
      for (let i = 0; i < 24; i++) {
        const date = new Date(Date.now() - i * 7 * 24 * 60 * 60 * 1000);
        data.push({
          date: date.toISOString().split('T')[0],
          value: Math.random() * 1000,
        });
      }
      return data.reverse();
    }

    // 抓取數據（透過無伺服器函數）
    async function fetchData(item) {
      try {
        if (item.api === 'mock') {
          return generateMockData();
        }

        let url = `/api/fetch-data?api=${item.api}`;
        if (item.api === 'TIME_SERIES_WEEKLY') {
          url += `&symbol=${item.symbol}`;
        } else if (item.api === 'CURRENCY_EXCHANGE_RATE') {
          url += `&from=${item.from}&to=${item.to}`;
        }

        const response = await fetch(url);
        if (!response.ok) throw new Error('API請求失敗');
        const data = await response.json();

        if (item.api === 'TIME_SERIES_WEEKLY') {
          const weeklyData = data['Weekly Time Series'];
          if (!weeklyData) throw new Error('無數據');
          const entries = Object.entries(weeklyData)
            .slice(0, 24)
            .map(([date, values]) => ({
              date,
              value: parseFloat(values['4. close']),
            }))
            .reverse();
          return entries;
        } else if (item.api === 'CURRENCY_EXCHANGE_RATE') {
          const rate = parseFloat(data['Realtime Currency Exchange Rate']['5. Exchange Rate']);
          const mockDates = generateMockData().map(d => d.date);
          return mockDates.map(date => ({
            date,
            value: rate,
          }));
        }
      } catch (error) {
        console.error(`抓取${item.label}失敗:`, error);
        return generateMockData();
      }
    }

    // 主函數
    async function init() {
      const allData = {};
      const errorDiv = document.getElementById('error');

      try {
        // 檢查 Chart.js 是否載入
        if (typeof Chart === 'undefined') {
          throw new Error('無法載入 Chart.js，請檢查網路連線或稍後重試');
        }

        // 抓取所有數據
        for (const item of dataItems) {
          allData[item.key] = await fetchData(item);
        }

        // 繪製圖表
        dataItems.forEach(item => {
          const ctx = document.getElementById(item.chartId);
          if (!ctx) {
            throw new Error(`找不到圖表元素：${item.chartId}`);
          }
          const chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: allData[item.key].map(d => d.date),
              datasets: [{
                label: item.label,
                data: allData[item.key].map(d => d.value),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
              }],
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: '日期' } },
                y: { title: { display: true, text: '數值' } },
              },
            },
          });
        });

        // 匯出CSV
        document.getElementById('export-csv').addEventListener('click', () => {
          const headers = ['日期', ...dataItems.map(item => item.label)];
          const rows = [];
          for (let i = 0; i < 24; i++) {
            const row = [allData[dataItems[0].key][i].date];
            dataItems.forEach(item => {
              row.push(allData[item.key][i].value.toFixed(2));
            });
            rows.push(row);
          }
          const csvContent = [headers, ...rows]
            .map(row => row.map(cell => `"${cell}"`).join(','))
            .join('\n');
          const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'financial_data.csv';
          link.click();
        });
      } catch (error) {
        errorDiv.textContent = '頁面載入失敗：' + error.message;
        errorDiv.classList.remove('hidden');
        console.error(error);
      }
    }

    // 等待 Chart.js 載入後執行
    waitForChartJs(init);
  </script>
</body>
</html>
